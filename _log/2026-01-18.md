# Log 2026-01-18

## 1. Session Objective

Fix iOS EventKit crash during calendar event creation and confirm calendar events can be added without opening the Calendar app.

## 2. Key Changes & Implementation

### Calendar Event Creation Fix (EventCard)

- **Modified:** `lib/presentation/genui/widgets/event_card.dart`
  - Omitted optional string fields when empty to avoid `NSNull` on iOS (`description`, `location`)
  - Validated attendees and only created `Attendee` objects when a valid email is present
  - Added helper methods to sanitize optional strings and parse attendee input
  - Set default `AttendeeRole.Required` for all attendees to avoid `NSNull` → `NSNumber` crash
  - Skip attendees on iOS to avoid `PlatformException(500)` - EventKit doesn't allow programmatic attendee changes
  - Added iOS-only info hint below attendees: "Attendees shown for reference only on iOS. Add attendees manually in the calendar app."
  - Improved error message display to show `ResultError.errorMessage` instead of `toString()`
- **Technical Decision:** Prefer omission of empty optional fields over empty strings; EventKit crashes when it receives `NSNull` for optional values or attendees without email. iOS EventKit limitations require skipping attendees programmatically.

### Time Awareness in System Prompt

- **Modified:** `lib/data/datasources/genui/genui_system_prompt_builder.dart`
  - Added `_getCurrentTimeInfo()` method that formats current date/time/timezone
  - Prepend time information to every system prompt
  - Includes: current date (formatted), time, ISO 8601 format, timezone name and UTC offset, day of week, day of year
  - Uses local system time via `DateTime.now()` - no network calls needed
- **Technical Decision:** Use local device time for time awareness - sufficient for conversational agent, no need for external time API

## 3. Challenges & Debugging

### EventKit Crash: "Could not cast NSNull to NSString"

- **Symptoms:** App crashed immediately after calling `createOrUpdateEvent`
- **Hypothesis:** Optional fields (strings or attendees) were being passed as null/invalid, causing EventKit to cast `NSNull` to `NSString`
- **Solution:** Omit empty optional fields and only send attendees with valid email addresses
- **Takeaway:** EventKit is strict about optional values; avoid sending empty or invalid optional data

### iOS Attendees Not Supported (PlatformException 500)

- **Symptoms:** `PlatformException(500, Attendees cannot be changed.)` when adding events with attendees on iOS
- **Hypothesis:** EventKit blocks programmatic attendee changes for many calendars
- **Solution:** Skip attendees on iOS; keep attendees in UI for context with informative hint
- **Note:** Adding `confirmed` status to attendees can bypass this in some cases, but was intentionally not used to avoid workarounds
- **UX:** Added subtle blue info hint below attendees on iOS: "Attendees shown for reference only on iOS. Add attendees manually in the calendar app."

## 4. Current Status

- [x] Calendar event creation works without opening Calendar app
- [x] iOS crash resolved when creating events (NSNull → NSString/NSNumber)
- [x] EventCard status updates correctly after successful creation
- [x] iOS attendee limitation handled gracefully (skipped programmatically, shown in UI with hint)
- [x] Time awareness added to system prompt (local device time)
- [x] Error messages improved (show actual error message instead of object toString)

## 5. Next Steps

- [x] Calendar event feature complete
- [ ] Consider reducing debug logging in production builds

## 6. Files Modified

- `lib/presentation/genui/widgets/event_card.dart` - Fixed iOS crashes, added attendee handling, iOS info hint
- `lib/data/datasources/genui/genui_system_prompt_builder.dart` - Added time awareness
- `lib/data/datasources/genui/genui_system_prompt.dart` - Updated EventCard documentation with iOS attendee limitation note
