# Log 2026-01-16

## 1. Session Objective

Transform the LLM integration from passive text generation into an **Agentic GenUI System** with dynamic UI components, proper chat history rendering, and automatic service provider detection.

## 2. Key Changes & Implementation

### Agentic GenUI Architecture

- **Added:** `genui_system_prompt.dart` — Agent persona + available tools (`InfoCard`, `StatusBadge`)
- **Modified:** `RealGenUiContentGenerator` — JSON parsing with unique timestamp-based surface IDs
- **Technical Decision:** Strict JSON schema (`{ text, ui_components }`) ensures reliable parsing

### Service Provider & Model Selection

- **Modified:** `chat_bloc.dart` — Auto-detect first available API key, auto-select first model
- **Modified:** `chat_state.dart` — Removed hardcoded `gpt-3.5-turbo-0613` defaults
- **Modified:** `main.dart` — `InitializeAppEvent` dispatched in `BlocProvider.create`
- **Technical Decision:** Priority order Gemini → Groq → Perplexity → Dyrektywa → OpenAI

### Custom Chat UI & History

- **Added:** Custom `chat_page_chat_widget.dart` — Replaced `flutter_chat_ui` (had fatal API mismatch)
- **Added:** `history_content_generator.dart` — Re-emits saved `uiComponents` as surface events
- **Added:** `gen_ui_history_widget.dart` — Hydrates stored widget definitions into live surfaces
- **Modified:** `chat_message_repository.dart` — Multi-stage JSON parsing (code blocks, mixed text)
- **Added:** `flutter_markdown` with custom `MarkdownStyleSheet` for chat bubbles

### Documentation

- **Added:** `docs/genui_widget_roadmap.md` — Future components: Charts, Calendar, Reminders

## 3. Challenges & Debugging

### Ghost Widget State Collision

- **Symptoms:** Historical widgets in chat updated to match newest response
- **Hypothesis:** Shared state between GenUI surfaces
- **Solution:** Unique timestamp-based surface IDs per response in `RealGenUiContentGenerator`
- **Takeaway:** Each `GenUiSurface` must have a unique ID to prevent stream interference

### InitializeAppEvent Never Dispatched

- **Symptoms:** Code changes applied but UI still showed OpenAI and deprecated model
- **Hypothesis:** Hot reload issue, needed full restart
- **Solution:** Wrong entry point modified; moved dispatch to `BlocProvider.create` in `main.dart`
- **Takeaway:** Verify actual entry point when multiple `main()` functions exist

### LLM Message Order Confusion

- **Symptoms:** LLM numbered messages backwards (newest = 1)
- **Hypothesis:** Display order was correct but API context reversed
- **Solution:** Reverse message list before API call: `messages.reversed.toList()`
- **Takeaway:** UI needs newest-at-bottom, LLM needs chronological order

### Raw Markdown in Chat

- **Symptoms:** LLM wrapped markdown examples in code fences
- **Hypothesis:** LLM "over-formatting" when demonstrating formatting
- **Solution:** Outer code fence stripping in `ChatMessageRepository`
- **Takeaway:** Post-processing needed for LLM formatting artifacts

## 4. Current Status

- [x] Agentic GenUI system with structured output
- [x] Unique surface IDs (no ghost widget bug)
- [x] Custom chat widget with GenUI support
- [x] GenUI history hydration from `uiComponents`
- [x] Service provider auto-detection
- [x] Markdown rendering with proper styling
- [x] Correct message ordering

## 5. Next Steps

### Phase 1: Merge Prototype Chat into Main Chat
- [x] Integrate `PrototypeChatPage` UI/UX improvements into `ChatPage`
- [x] Merge Claude-inspired design (warm colors, modern bubbles) with existing BLoC architecture
- [x] Preserve existing features (drawer, API key management, service/model selection)
- [x] Ensure GenUI surfaces work seamlessly in merged chat

### Phase 2: Calendar Integration Testing (Priority)
- [ ] Implement `EventCard` GenUI component (from roadmap)
- [ ] Test calendar meeting creation flow end-to-end
- [ ] Verify "Add to Calendar" buttons trigger correct system dialogs/windows
- [ ] Ensure proper date/time formatting and timezone handling
- [ ] Test recurring events if applicable
- [ ] Validate UI/UX for calendar actions (add, view, edit)

### Phase 3: MCP Server Integration
- [ ] Set up MCP server infrastructure (remote servers for mobile)
- [ ] Integrate MCP protocol into content generator pipeline
- [ ] Test MCP server discovery and connection
- [ ] Verify MCP tools/resources are accessible to LLM agent

### Phase 4: Frontend Agent Rendering Logic
- [ ] Extend GenUI catalog with MCP-driven components:
  - [ ] Email widgets (from MCP mail servers)
  - [ ] Calendar widgets (from MCP calendar servers)
  - [ ] Notes widgets (from MCP notes servers)
  - [ ] Reminders widgets (from MCP reminder servers)
  - [ ] Weather widgets (from MCP weather servers)
- [ ] Ensure frontend agent can dynamically render any MCP-provided data structure
- [ ] Test bidirectional sync for interactive widgets (e.g., reminder checkboxes)
- [ ] Validate error handling when MCP servers are unavailable

## 6. MCP Server Integration Implementation (2026-01-16 Session 2)

### Implementation Completed

#### Phase 1: Data Models & Storage
- [x] Created `McpServerConfig` Hive model (typeId: 6) with fields: id, name, url, transportType, authType, authToken, isEnabled, lastTested, lastError
- [x] Created domain entities: `McpTool`, `McpServerInfo`
- [x] Set up encrypted storage for server configs using existing Hive encrypted box

#### Phase 2: MCP Client Service
- [x] Implemented `HttpMcpTransport` for HTTP-based MCP communication
- [x] Created `McpClient` with methods: initialize(), listTools(), callTool(), listResources(), readResource()
- [x] Implemented JSON-RPC 2.0 protocol over HTTP
- [x] Added connection testing with timeout and error handling
- [x] Created `McpServerService` for managing server configs, persistence, and connection testing

#### Phase 3: Settings UI Integration
- [x] Added "MCP Servers" option to Settings page
- [x] Created `McpServersPage` with full CRUD functionality (list, add, edit, delete)
- [x] Implemented connection status indicators (green/yellow/red)
- [x] Added enable/disable toggle per server
- [x] Created iOS-style `AddMcpServerPage` (full page, not dialog) with:
  - CupertinoPageScaffold with proper iOS navigation bar
  - Grouped sections with rounded corners (iOS design pattern)
  - CupertinoTextField for text inputs
  - CupertinoActionSheet for picker selections
  - Proper form validation with real-time feedback
  - Test connection button with loading state

#### Phase 4: System Prompt Integration
- [x] Created `GenUiSystemPromptBuilder` to dynamically include MCP tools in system prompts
- [x] Integrated MCP tool discovery into `ChatNetworkDataSource`
- [x] Created `GetAvailableMcpToolsUseCase`
- [x] Tools are automatically included in LLM system prompts when servers are enabled

#### Phase 5: Tool Execution Integration
- [x] Implemented `McpToolExecutor` to parse tool calls from LLM responses
- [x] Created `ToolResultFormatter` that uses LLM agent to format raw tool results
- [x] Integrated tool execution into `ChatMessageRepository`
- [x] Tool results are automatically formatted using GenUI components via formatting agent
- [x] Created use cases: `ExecuteMcpToolUseCase`, `FormatToolResultUseCase`

#### Phase 6: Error Handling
- [x] Created MCP-specific error types: `McpConnectionError`, `McpProtocolError`, `McpToolExecutionError`, `McpAuthenticationError`
- [x] Added comprehensive error handling throughout the flow
- [x] User-friendly error messages in UI using CupertinoAlertDialog
- [x] Fixed type casting issues in `_getServersList` to handle Hive's `Map<dynamic, dynamic>`

#### Phase 7: Testing
- [x] Created unit tests for MCP client
- [x] Created tests for tool executor

### Technical Decisions

1. **Transport Priority**: Started with HTTP transport (simpler, more widely supported). SSE can be added later.
2. **Storage**: Using encrypted Hive box (same as API keys) for MCP server configs, with auth tokens stored separately in FlutterSecureStorage.
3. **Tool Discovery**: Query all enabled MCP servers on app initialization and cache tool lists.
4. **Tool Calling Format**: LLM outputs JSON tool calls in responses, parsed and executed before displaying.
5. **Tool Result Formatting**: After tool execution returns raw result, send it to formatting agent (LLM) with available GenUI components. Agent formats result into user-friendly response with appropriate UI components.
6. **Error Recovery**: If MCP server is unavailable, show error in chat but don't block LLM response. If formatting agent fails, fallback to displaying raw tool result.
7. **UI Design**: Implemented iOS-style UI using Cupertino widgets following Apple Human Interface Guidelines.

### Current Status

- [x] MCP server configuration UI (add/edit/delete/test)
- [x] MCP client with HTTP transport
- [x] Tool discovery and system prompt integration
- [x] Tool execution with formatting agent
- [x] Error handling and user feedback
- [x] iOS-style UI implementation
- [ ] UI polishing needed (formatting issues with text underlines)
- [ ] Testing MCP server connectivity end-to-end
- [ ] Testing tool execution flow
- [ ] Fix duplicate server instances issue

### Known Issues

1. **UI Formatting**: Yellow underlines appearing on text (likely iOS data detection) - needs further investigation
2. **Duplicate Instances**: Server loading creates multiple instances - needs debugging
3. **Hive Adapter**: Requires running `flutter pub run build_runner build --delete-conflicting-outputs` to generate `McpServerConfigAdapter`

### Next Steps

1. **UI Polish**: Fix text formatting issues (remove unwanted underlines, ensure proper iOS styling)
2. **Testing**: Test MCP server connectivity with real servers
3. **Debugging**: Fix duplicate server instances issue
4. **Integration Testing**: Test full flow from adding server → tool discovery → tool execution → result formatting
5. **Error Handling**: Verify error scenarios (server down, auth failure, tool execution failure)

## 7. Prototype Chat UI Integration (2026-01-16 Session 3)

### Implementation Completed

#### UI/UX Improvements
- [x] Integrated Claude-inspired design from `PrototypeChatPage` into main `ChatPage`
- [x] Updated `ChatPageChatWidget` with warm color scheme:
  - Background: `#FAF9F6` (warm off-white)
  - User bubbles: `#E5E5E0` (muted warm gray)
  - Accent color: `#DA7756` (burnt orange/terracotta)
- [x] Modern message bubble design with rounded corners (16px radius)
- [x] User messages: right-aligned with teal avatar
- [x] AI messages: left-aligned with accent-colored icon badge
- [x] Empty state with centered icon and "How can I help you today?" message
- [x] Enhanced input area with shadow, rounded corners, and circular send button
- [x] Updated `ChatPage` app bar to match warm theme (removed elevation)

#### Code Changes
- **Modified:** `chat_page_chat_widget.dart`:
  - Replaced basic chat UI with PrototypeChatPage-inspired design
  - Added proper message ordering (newest at bottom)
  - Integrated empty state widget
  - Updated input area with modern styling
  - Removed "Interactive Component" wrapper header (GenUI components render directly)
- **Modified:** `chat_page.dart`:
  - Updated app bar background to warm off-white
  - Removed elevation for flat design
- **Modified:** `prototype_chat_page.dart`:
  - Removed mock switch toggle button from app bar actions

#### Technical Decisions

1. **Message Ordering**: Messages stored newest-first in state, reversed for display (newest at bottom)
2. **GenUI Rendering**: Removed wrapper container/header - components render directly for cleaner UI
3. **Color Scheme**: Maintained Claude-inspired warm palette throughout for consistency
4. **Preserved Features**: All existing functionality maintained (BLoC, drawer, API keys, service/model selection)

### Current Status

- [x] PrototypeChatPage design fully integrated into ChatPage
- [x] Warm color scheme applied consistently
- [x] Modern bubble design implemented
- [x] Empty state added
- [x] Enhanced input area with modern styling
- [x] GenUI components render cleanly without wrapper
- [x] All existing features preserved and functional
