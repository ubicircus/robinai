# Log 2026-01-17

## 1. Session Objective

Implement calendar event creation functionality with permission handling, state persistence, and LLM follow-up messages - similar to Claude's calendar integration.

## 2. Key Changes & Implementation

### Calendar Event GenUI Component

- **Added:** `EventCard` GenUI widget component (`lib/presentation/genui/widgets/event_card.dart`)
  - Displays calendar events with title, time, location, attendees, description
  - Handles permission requests and event creation
  - Shows status states: pending, requesting, created, denied, failed
  - Includes retry functionality for failed/denied states
  - Color-coded left border indicating status

- **Added:** Calendar packages to `pubspec.yaml`:
  - `device_calendar: ^4.3.3` (for direct calendar access)
  - `permission_handler: ^11.3.1` (for permission requests)
  - `timezone: ^0.9.4` (for timezone handling)

- **Modified:** `lib/presentation/genui/catalog.dart`
  - Registered `EventCard` component in GenUI catalog
  - Added schema definition with required/optional properties

- **Modified:** `lib/data/datasources/genui/genui_system_prompt.dart`
  - Added EventCard documentation and usage examples
  - Included calendar event creation instructions for LLM

### Permission Configuration

- **Modified:** `ios/Runner/Info.plist`
  - Added `NSCalendarsUsageDescription` (for iOS ≤16)
  - Added `NSCalendarsFullAccessUsageDescription` (for iOS 17+)
  - Added `NSCalendarsWriteOnlyAccessUsageDescription` (for write-only access)
  - Added `NSContactsUsageDescription` (for event attendees)

- **Modified:** `ios/Podfile`
  - Added `PERMISSION_EVENTS=1` macro
  - Added `PERMISSION_EVENTS_FULL_ACCESS=1` macro
  - Configured in `post_install` block for all targets

- **Modified:** `android/app/src/main/AndroidManifest.xml`
  - Added `READ_CALENDAR` permission
  - Added `WRITE_CALENDAR` permission

### Calendar Event Service & Chat Integration

- **Added:** `lib/presentation/services/calendar_event_service.dart`
  - Singleton service to handle event status changes
  - Notifies ChatBloc when permissions are granted/denied or events are created/failed
  - Only sends LLM notifications for failures/denials (not success)

- **Modified:** `lib/presentation/bloc/chat_bloc.dart`
  - Added `CalendarEventStatusEvent` handler
  - Sends follow-up messages to LLM only for denied/failed cases
  - Removed duplicate success confirmations

- **Modified:** `lib/presentation/bloc/chat_event.dart`
  - Added `CalendarEventStatusEvent` class

- **Modified:** `lib/presentation/pages/chat_page/chat_page_chat_widget.dart`
  - Set chat context for CalendarEventService to access ChatBloc

### State Persistence

- **Modified:** `lib/presentation/genui/widgets/event_card.dart`
  - Added static cache (`_eventStatusCache`, `_eventErrorCache`) to persist event status
  - Status restores from cache when widget is recreated from history
  - Prevents state reset when scrolling back to events

## 3. Challenges & Debugging

### MissingPluginException with permission_handler

- **Symptoms:** `MissingPluginException (No implementation found for method checkPermissionStatus on channel flutter.baseflow.com/permissions/methods)`
- **Hypothesis:** `permission_handler` package not properly configured or native code not linked
- **Solution:** Switched from `permission_handler` to `device_calendar`'s built-in permission methods (`hasPermissions()`, `requestPermissions()`)
- **Takeaway:** `device_calendar` uses EventKit directly and handles permissions natively - don't mix permission_handler with device_calendar

### App Crashes with "Could not cast NSNull to NSString"

- **Symptoms:** App crashes immediately after permission granted with error: `Could not cast value of type 'NSNull' (0x...) to 'NSString' (0x...)`
- **Hypothesis:** EventKit API receiving null values for optional string fields (description, location)
- **Attempted Solutions:**
  1. Changed from `null` to empty strings (`''`) for optional fields
  2. Updated `device_calendar` from 4.1.0 to 4.3.3 (iOS 17 fixes)
  3. Added null checks and validation before creating Event
  4. Tried omitting optional parameters entirely vs passing null vs passing empty strings
- **Current Status:** **UNRESOLVED** - Still crashes even with empty strings
- **Takeaway:** EventKit on iOS is very strict about null values. Need to investigate Event constructor API more carefully - may need to use different approach or check if device_calendar version has bugs

### Permission Dialog Not Appearing Initially

- **Symptoms:** Permission dialog didn't show up, app showed "permanently denied" immediately
- **Hypothesis:** Missing Info.plist keys or Podfile configuration
- **Solution:** 
  - Added all required iOS 17+ permission keys
  - Added Podfile macros for permission_handler
  - Reinstalled CocoaPods dependencies
- **Takeaway:** iOS 17+ requires `NSCalendarsFullAccessUsageDescription` in addition to deprecated `NSCalendarsUsageDescription`

### State Not Persisting in History

- **Symptoms:** When scrolling back to event card in chat history, status resets to "pending"
- **Hypothesis:** Widget state not preserved when recreated from GenUI history
- **Solution:** Added static cache map keyed by `eventId` to persist status across widget recreations
- **Takeaway:** GenUI history widgets are recreated fresh - need external state storage for persistence

### Duplicate Confirmation Messages

- **Symptoms:** Three confirmation messages appeared: system message, user message, LLM response
- **Hypothesis:** CalendarEventService and ChatBloc both sending messages for success cases
- **Solution:** Removed success notifications - only send LLM messages for denied/failed cases
- **Takeaway:** Avoid duplicate user feedback - UI already shows success state

### False Success on Cancel

- **Symptoms:** When user cancelled calendar app, it still showed as "created"
- **Hypothesis:** `add_2_calendar` returns true when calendar app opens, not when user saves
- **Solution:** Switched to `device_calendar` which can detect actual success/failure
- **Takeaway:** `add_2_calendar` opens native app and can't detect user action - need direct API access

## 4. Current Status

- [x] EventCard GenUI component created and registered
- [x] Calendar permissions configured in Info.plist and Podfile
- [x] Permission dialog appears and can be accepted
- [x] State persistence implemented with static cache
- [x] Duplicate confirmations removed
- [x] Calendar event service integrated with ChatBloc
- [ ] **CRITICAL: App crashes when creating event** - "Could not cast NSNull to NSString" error persists
- [ ] Event creation not working - crashes before completion

## 5. Next Steps

### Immediate Priority: Fix EventKit Crash

- [ ] **Investigate Event constructor API** - Check device_calendar documentation/examples for correct usage
- [ ] **Test with minimal event** - Try creating event with only required fields (title, start, end, calendarId)
- [ ] **Check device_calendar version compatibility** - Verify 4.3.3 works with current iOS version
- [ ] **Alternative approach:** Consider using EventKit directly via platform channels if device_calendar has bugs
- [ ] **Debug native side** - Check Xcode console for more detailed error information
- [ ] **Test on different iOS versions** - May be iOS 17+ specific issue

### Code Review Needed

- [ ] Verify Event constructor parameter types match device_calendar API
- [ ] Check if attendees list format is correct (Attendee objects)
- [ ] Verify timezone handling (TZDateTime conversion)
- [ ] Consider creating event in steps: create → update optional fields

### Known Issues to Address

- [ ] App crashes when `createOrUpdateEvent` is called
- [ ] Need to verify if empty strings vs null vs omitted parameters is correct approach
- [ ] May need to check device_calendar GitHub issues for similar crash reports

## 6. Technical Decisions Made

1. **Permission Handling:** Use `device_calendar`'s native permission methods instead of `permission_handler` to avoid conflicts
2. **State Persistence:** Use static cache map instead of trying to serialize state in GenUI history
3. **Success Notifications:** Don't send LLM messages for success - UI feedback is sufficient
4. **Package Choice:** Switched from `add_2_calendar` to `device_calendar` for direct API access and success detection

## 7. Files Modified

- `lib/presentation/genui/widgets/event_card.dart` (new file, 478 lines)
- `lib/presentation/genui/catalog.dart`
- `lib/data/datasources/genui/genui_system_prompt.dart`
- `lib/presentation/services/calendar_event_service.dart` (new file)
- `lib/presentation/bloc/chat_bloc.dart`
- `lib/presentation/bloc/chat_event.dart`
- `lib/presentation/pages/chat_page/chat_page_chat_widget.dart`
- `pubspec.yaml`
- `ios/Runner/Info.plist`
- `ios/Podfile`
- `android/app/src/main/AndroidManifest.xml`

## 8. Critical Issue: EventKit Crash

**Error:** `Could not cast value of type 'NSNull' (0x...) to 'NSString' (0x...)`

**When it occurs:** Immediately after calling `deviceCalendarPlugin.createOrUpdateEvent(event)` when permission is granted

**What we've tried:**
1. Passing empty strings instead of null for description/location
2. Passing null for optional fields
3. Omitting optional parameters
4. Updating device_calendar to 4.3.3
5. Validating all inputs before creating Event
6. Checking calendar ID is not null

**Current hypothesis:** The Event constructor or device_calendar plugin may have a bug, or we're using the API incorrectly. The crash happens in native EventKit code, suggesting a parameter type mismatch.

**Recommended next steps:**
1. Check device_calendar GitHub issues for similar crashes
2. Review device_calendar example code/documentation
3. Try creating event with absolute minimum fields only
4. Consider alternative calendar plugin or native EventKit implementation
5. Check Xcode crash logs for more detailed stack trace

## 9. Future Tasks (From Previous Session)

### Phase 2: Calendar Integration Testing (Priority) - IN PROGRESS
- [x] Implement `EventCard` GenUI component (from roadmap)
- [ ] Test calendar meeting creation flow end-to-end
- [ ] Verify "Add to Calendar" buttons trigger correct system dialogs/windows
- [ ] Ensure proper date/time formatting and timezone handling
- [ ] Test recurring events if applicable
- [ ] Validate UI/UX for calendar actions (add, view, edit)

### Phase 3: MCP Server Integration
- [ ] Set up MCP server infrastructure (remote servers for mobile)
- [ ] Integrate MCP protocol into content generator pipeline
- [ ] Test MCP server discovery and connection
- [ ] Verify MCP tools/resources are accessible to LLM agent

### Phase 4: Frontend Agent Rendering Logic
- [ ] Extend GenUI catalog with MCP-driven components:
  - [ ] Email widgets (from MCP mail servers)
  - [ ] Calendar widgets (from MCP calendar servers)
  - [ ] Notes widgets (from MCP notes servers)
  - [ ] Reminders widgets (from MCP reminder servers)
  - [ ] Weather widgets (from MCP weather servers)
- [ ] Ensure frontend agent can dynamically render any MCP-provided data structure
- [ ] Test bidirectional sync for interactive widgets (e.g., reminder checkboxes)
- [ ] Validate error handling when MCP servers are unavailable
